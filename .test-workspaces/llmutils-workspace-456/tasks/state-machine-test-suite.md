Write a comprehensive test suite for the state machine functionality.
